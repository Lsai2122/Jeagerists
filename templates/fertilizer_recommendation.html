{% extends "base.html" %}

{% block title %}Fertilizer Recommendation - KrishiKavach{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center">
                        <i class="fas fa-flask-potion me-2"></i>Fertilizer Recommendation
                    </h2>
                    <p class="text-center mb-5">
                        Provide your crop and soil details to receive a tailored fertilizer recommendation.
                    </p>
                    <form id="fertilizerForm">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-seedling"></i></span>
                                    <select class="form-control" id="crop" name="crop" required>
                                        <option value="">Select Crop</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Maize">Maize</option>
                                        <option value="Cotton">Cotton</option>
                                        <option value="Sugarcane">Sugarcane</option>
                                        <option value="Groundnut">Groundnut</option>
                                        <option value="Soyabean">Soyabean</option>
                                        <option value="Potato">Potato</option>
                                        <option value="Onion">Onion</option>
                                        <option value="Tomato">Tomato</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <select class="form-control" id="state" name="state" required>
                                        <option value="">Select State</option>
                                        <option value="Karnataka">Karnataka</option>
                                        <option value="Maharashtra">Maharashtra</option>
                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                        <option value="Andhra Pradesh">Andhra Pradesh</option>
                                        <option value="Telangana">Telangana</option>
                                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                                        <option value="Punjab">Punjab</option>
                                        <option value="Haryana">Haryana</option>
                                        <option value="Gujarat">Gujarat</option>
                                        <option value="West Bengal">West Bengal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-ruler-combined"></i></span>
                                    <input type="number" class="form-control" id="area" name="area" placeholder="Area (Hectares)" step="0.1" min="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-cloud-rain"></i></span>
                                    <input type="number" class="form-control" id="annual_rainfall" name="annual_rainfall" placeholder="Annual Rainfall (mm)" step="0.1" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-chart-line"></i></span>
                                    <input type="number" class="form-control" id="yield" name="yield" placeholder="Expected Yield (kg/hectare)" step="0.1" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    <input type="number" class="form-control" id="crop_year" name="crop_year" placeholder="Crop Year" min="2020" max="2030" value="2024" required>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Get Recommendation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="results" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card result-card">
                    <div class="card-body">
                        <h3 class="card-title text-center">
                            <i class="fas fa-chart-bar me-2"></i>Recommendation Results
                        </h3>
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h4>Fertilizer Mix</h4>
                                <p id="fertilizerRec"></p>
                                <p>NPK (grams per hectare)</p>
                            </div>
                            <div class="col-md-6">
                                <h4>Pesticide</h4>
                                <p id="pesticideRec"></p>
                                <p>Recommendation</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 rounded">
                            <h5><i class="fas fa-info-circle me-2"></i>Application Guidelines</h5>
                            <ul>
                                <li>Apply fertilizer during the cooler parts of the day.</li>
                                <li>Ensure the soil is moist before and after application.</li>
                                <li>Store all products in a cool, dry, and secure location.</li>
                                <li>Always adhere to local agricultural safety standards.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('fertilizerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoading();

        const formData = {
            crop: document.getElementById('crop').value,
            state: document.getElementById('state').value,
            area: parseFloat(document.getElementById('area').value),
            annual_rainfall: parseFloat(document.getElementById('annual_rainfall').value),
            yield: parseFloat(document.getElementById('yield').value),
            crop_year: parseInt(document.getElementById('crop_year').value)
        };

        try {
            const response = await fetch('/predict_fertilizer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.error) {
                showAlert(result.error, 'danger');
            } else {
                document.getElementById('fertilizerRec').textContent = `${result.nitrogen} N / ${result.phosphorus} P / ${result.potassium} K`;
                document.getElementById('pesticideRec').textContent = result.pesticide_recommendation || 'None';
                document.getElementById('results').style.display = 'block';
                showAlert('Recommendation generated successfully!', 'success');
            }
        } catch (error) {
            showAlert('An error occurred while generating the recommendation. Please try again.', 'danger');
        } finally {
            hideLoading();
        }
    });
</script>
{% endblock %}